<!DOCTYPE html>
<html lang="id">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - GDG Donation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="stylesheet" href="/styles.css" />
  <style>
   .admin-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
   }
   .login-form {
    max-width: 400px;
    margin: 100px auto;
    background: var(--card-bg);
    padding: 40px;
    border-radius: 8px;
    box-shadow: var(--shadow);
   }
   .admin-dashboard {
    display: none;
   }
   .admin-dashboard.active {
    display: block;
   }
   .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
   }
   .disbursement-form {
    background: var(--card-bg);
    padding: 25px;
    border-radius: 8px;
    box-shadow: var(--shadow);
    margin-bottom: 30px;
   }
   .disbursements-list {
    background: var(--card-bg);
    padding: 25px;
    border-radius: 8px;
    box-shadow: var(--shadow);
   }
   .disbursement-item {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
   }
   .disbursement-item:last-child {
    border-bottom: none;
   }
   .disbursement-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
   }
   .disbursement-actions {
    display: flex;
    gap: 10px;
   }
   .activity-btn {
    padding: 5px 15px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
   }
   .activity-btn:hover {
    opacity: 0.9;
   }
   .activities-section {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
    display: none;
   }
   .activities-section.active {
    display: block;
   }
   .activity-form {
    background: var(--bg-color);
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 15px;
   }
   .activity-item {
    padding: 10px;
    background: var(--bg-color);
    border-radius: 6px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: start;
   }
   .activity-time {
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 5px;
   }
   .activity-description {
    color: var(--text-color);
    flex: 1;
   }
   .logout-btn {
    float: right;
    padding: 10px 20px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 20px;
   }
   .logout-btn:hover {
    background: #c82333;
   }
  </style>
 </head>
 <body>
  <div class="admin-container">
   <!-- Login Form -->
   <div id="login-section" class="login-form">
    <h2>Admin Login</h2>
    <form id="login-form">
     <div class="form-group">
      <label for="password">Password</label>
      <input type="password" id="password" name="password" required />
     </div>
     <button type="submit" class="submit-btn">Login</button>
    </form>
    <div
     id="login-error"
     style="color: #dc3545; margin-top: 10px; display: none"
    ></div>
   </div>

   <!-- Admin Dashboard -->
   <div id="admin-dashboard" class="admin-dashboard">
    <button class="logout-btn" onclick="logout()">Logout</button>
    <h1>Admin Dashboard</h1>

    <!-- Stats -->
    <div class="stats-grid">
     <div class="summary-card">
      <h3>Total Terkumpul</h3>
      <p class="amount" id="admin-total-raised">Rp 0</p>
     </div>
     <div class="summary-card">
      <h3>Total Disalurkan</h3>
      <p class="amount" id="admin-total-disbursed">Rp 0</p>
     </div>
     <div class="summary-card">
      <h3>Jumlah Donatur</h3>
      <p class="amount" id="admin-donor-count">0</p>
     </div>
     <div class="summary-card">
      <h3>Saldo Tersedia</h3>
      <p class="amount" id="admin-balance">Rp 0</p>
     </div>
    </div>

    <!-- Add Disbursement Form -->
    <div class="disbursement-form">
     <h2>Tambah Pencairan</h2>
     <form id="disbursement-form">
      <div class="form-group">
       <label for="disbursement-amount">Jumlah (Rp) *</label>
       <input
        type="number"
        id="disbursement-amount"
        name="amount"
        min="1"
        required
       />
      </div>
      <div class="form-group">
       <label for="disbursement-description">Deskripsi *</label>
       <textarea
        id="disbursement-description"
        name="description"
        rows="3"
        required
       ></textarea>
      </div>
      <button type="submit" class="submit-btn">Tambah Pencairan</button>
     </form>
    </div>

    <!-- Disbursements List -->
    <div class="disbursements-list">
     <h2>Riwayat Pencairan</h2>
     <div id="disbursements-list">
      <p class="loading">Memuat data...</p>
     </div>
    </div>
   </div>
  </div>

  <script>
   let adminToken = localStorage.getItem("admin_token");
   let tokenExpiry = localStorage.getItem("admin_token_expiry");

   // Check if token is valid
   if (adminToken && tokenExpiry && new Date(tokenExpiry) > new Date()) {
    showDashboard();
   } else {
    showLogin();
    localStorage.removeItem("admin_token");
    localStorage.removeItem("admin_token_expiry");
   }

   function showLogin() {
    document.getElementById("login-section").style.display = "block";
    document.getElementById("admin-dashboard").classList.remove("active");
   }

   function showDashboard() {
    document.getElementById("login-section").style.display = "none";
    document.getElementById("admin-dashboard").classList.add("active");
    loadAdminData();
   }

   function logout() {
    localStorage.removeItem("admin_token");
    localStorage.removeItem("admin_token_expiry");
    adminToken = null;
    showLogin();
   }

   // Format currency
   function formatCurrency(amount) {
    return new Intl.NumberFormat("id-ID", {
     style: "currency",
     currency: "IDR",
     minimumFractionDigits: 0,
    }).format(amount);
   }

   // Format date in WIB (UTC+7)
   function formatDate(dateString) {
    // SQLite DATETIME format: "2025-12-01 19:11:26" (stored as UTC)
    // Convert to ISO format and treat as UTC
    let date;

    // Handle SQLite datetime format (YYYY-MM-DD HH:MM:SS)
    if (dateString.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/)) {
     // Replace space with T and add Z to indicate UTC
     date = new Date(dateString.replace(" ", "T") + "Z");
    } else if (
     dateString.includes("T") &&
     !dateString.includes("Z") &&
     !dateString.includes("+")
    ) {
     // ISO format without timezone, treat as UTC
     date = new Date(dateString + "Z");
    } else {
     date = new Date(dateString);
    }

    // Convert to WIB (UTC+7) - Asia/Jakarta
    return new Intl.DateTimeFormat("id-ID", {
     year: "numeric",
     month: "long",
     day: "numeric",
     hour: "2-digit",
     minute: "2-digit",
     timeZone: "Asia/Jakarta",
     timeZoneName: "short",
    }).format(date);
   }

   // Format datetime for input (YYYY-MM-DDTHH:mm)
   function formatDateTimeForInput(dateString) {
    let date;
    if (dateString.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/)) {
     date = new Date(dateString.replace(" ", "T") + "Z");
    } else if (
     dateString.includes("T") &&
     !dateString.includes("Z") &&
     !dateString.includes("+")
    ) {
     date = new Date(dateString + "Z");
    } else {
     date = new Date(dateString);
    }

    // Convert to WIB (UTC+7) and format for datetime-local input
    const wibDate = new Date(date.getTime() + 7 * 60 * 60 * 1000);
    const year = wibDate.getUTCFullYear();
    const month = String(wibDate.getUTCMonth() + 1).padStart(2, "0");
    const day = String(wibDate.getUTCDate()).padStart(2, "0");
    const hours = String(wibDate.getUTCHours()).padStart(2, "0");
    const minutes = String(wibDate.getUTCMinutes()).padStart(2, "0");

    return `${year}-${month}-${day}T${hours}:${minutes}`;
   }

   // Render activities list
   function renderActivities(activities) {
    if (activities.length === 0) {
     return '<p style="color: var(--text-light); font-style: italic;">Belum ada aktivitas.</p>';
    }

    return activities
     .map(
      (activity) => `
        <div class="activity-item">
          <div style="flex: 1;">
            <div class="activity-time">${formatDate(
             activity.activity_time
            )}</div>
            <div class="activity-description">${activity.description}</div>
            ${
             activity.file_url
              ? `
              <div style="margin-top: 10px;">
                <a 
                  href="${activity.file_url}" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  style="display: inline-flex; align-items: center; gap: 5px; color: var(--primary-color); text-decoration: none; font-size: 0.9rem;"
                >
                  <span>ðŸ“Ž</span>
                  <span>${activity.file_name || "Lihat File"}</span>
                </a>
                ${
                 activity.file_url.match(/\.(jpg|jpeg|png|gif|webp)$/i)
                  ? `<div style="margin-top: 8px;"><img src="${
                     activity.file_url
                    }" alt="${
                     activity.file_name || "Activity image"
                    }" style="max-width: 100%; max-height: 200px; border-radius: 4px; border: 1px solid var(--border-color);" /></div>`
                  : ""
                }
              </div>
            `
              : ""
            }
          </div>
        </div>
      `
     )
     .join("");
   }

   // Toggle activities section
   function toggleActivities(disbursementId) {
    const section = document.getElementById(`activities-${disbursementId}`);
    section.classList.toggle("active");
   }

   // Add activity
   async function addActivity(event, disbursementId) {
    event.preventDefault();

    const timeInput = document.getElementById(
     `activity-time-${disbursementId}`
    );
    const descriptionInput = document.getElementById(
     `activity-description-${disbursementId}`
    );
    const fileInput = document.getElementById(
     `activity-file-${disbursementId}`
    );
    const progressDiv = document.getElementById(
     `file-upload-progress-${disbursementId}`
    );

    // Convert local datetime to UTC for storage
    const localDateTime = timeInput.value; // Format: YYYY-MM-DDTHH:mm
    const localDate = new Date(localDateTime);
    // Convert from WIB (UTC+7) to UTC
    const utcDate = new Date(localDate.getTime() - 7 * 60 * 60 * 1000);
    const activityTime = utcDate.toISOString().slice(0, 19).replace("T", " ");

    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = "Memproses...";

    let fileUrl = null;
    let fileName = null;

    try {
     // Upload file if provided
     if (fileInput.files && fileInput.files.length > 0) {
      progressDiv.style.display = "block";
      const file = fileInput.files[0];

      const formData = new FormData();
      formData.append("file", file);

      const uploadResponse = await fetch("/api/admin/upload", {
       method: "POST",
       headers: {
        Authorization: `Bearer ${adminToken}`,
       },
       body: formData,
      });

      if (uploadResponse.status === 401) {
       logout();
       return;
      }

      if (!uploadResponse.ok) {
       const error = await uploadResponse.json();
       throw new Error(error.error || "File upload failed");
      }

      const uploadData = await uploadResponse.json();
      fileUrl = uploadData.file_url;
      fileName = uploadData.file_name;
      progressDiv.style.display = "none";
     }

     // Create activity
     const response = await fetch(
      `/api/admin/disbursements/${disbursementId}/activities`,
      {
       method: "POST",
       headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${adminToken}`,
       },
       body: JSON.stringify({
        activity_time: activityTime,
        description: descriptionInput.value,
        file_url: fileUrl,
        file_name: fileName,
       }),
      }
     );

     if (response.status === 401) {
      logout();
      return;
     }

     if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || "Failed to create activity");
     }

     // Reset form
     timeInput.value = "";
     descriptionInput.value = "";
     fileInput.value = "";
     progressDiv.style.display = "none";

     // Reload disbursements to show new activity
     await loadDisbursements();
    } catch (error) {
     alert("Terjadi kesalahan: " + error.message);
     progressDiv.style.display = "none";
    } finally {
     submitBtn.disabled = false;
     submitBtn.textContent = originalText;
    }
   }

   // Load admin data
   async function loadAdminData() {
    await loadStats();
    await loadDisbursements();
   }

   // Load stats
   async function loadStats() {
    try {
     const response = await fetch("/api/stats");
     if (!response.ok) throw new Error("Failed to load stats");

     const data = await response.json();
     const balance = data.totalRaised - data.totalDisbursed;

     document.getElementById("admin-total-raised").textContent = formatCurrency(
      data.totalRaised || 0
     );
     document.getElementById("admin-total-disbursed").textContent =
      formatCurrency(data.totalDisbursed || 0);
     document.getElementById("admin-donor-count").textContent =
      data.donorCount || 0;
     document.getElementById("admin-balance").textContent = formatCurrency(
      balance || 0
     );
    } catch (error) {
     console.error("Error loading stats:", error);
    }
   }

   // Load disbursements
   async function loadDisbursements() {
    const listElement = document.getElementById("disbursements-list");

    try {
     const response = await fetch("/api/admin/disbursements", {
      headers: {
       Authorization: `Bearer ${adminToken}`,
      },
     });

     if (response.status === 401) {
      logout();
      return;
     }

     if (!response.ok) throw new Error("Failed to load disbursements");

     const disbursements = await response.json();

     if (disbursements.length === 0) {
      listElement.innerHTML = '<p class="empty">Belum ada pencairan.</p>';
      return;
     }

     listElement.innerHTML = disbursements
      .map(
       (disbursement) => `
          <div class="disbursement-item">
            <div class="disbursement-header">
              <div>
                <div style="font-weight: 600; margin-bottom: 5px;">${
                 disbursement.description
                }</div>
                <div style="font-size: 0.85rem; color: var(--text-light);">${formatDate(
                 disbursement.created_at
                )}</div>
              </div>
              <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);">
                  ${formatCurrency(disbursement.amount)}
                </div>
                <button class="activity-btn" onclick="toggleActivities(${
                 disbursement.id
                })">
                  ${
                   (disbursement.activities || []).length > 0
                    ? "Lihat Aktivitas"
                    : "Tambah Aktivitas"
                  }
                </button>
              </div>
            </div>
            <div class="activities-section" id="activities-${disbursement.id}">
              <div class="activity-form">
                <h4 style="margin-bottom: 10px;">Tambah Aktivitas</h4>
                <form onsubmit="addActivity(event, ${disbursement.id})">
                  <div class="form-group">
                    <label>Waktu Aktivitas (WIB) *</label>
                    <input 
                      type="datetime-local" 
                      id="activity-time-${disbursement.id}" 
                      required
                      style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;"
                    />
                  </div>
                  <div class="form-group">
                    <label>Deskripsi Aktivitas *</label>
                    <textarea 
                      id="activity-description-${disbursement.id}" 
                      rows="3" 
                      required
                      placeholder="Contoh: Tiba di lokasi untuk mendistribusikan paket sembako"
                      style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;"
                    ></textarea>
                  </div>
                  <div class="form-group">
                    <label>Upload File (Opsional)</label>
                    <input 
                      type="file" 
                      id="activity-file-${disbursement.id}" 
                      accept="image/*,application/pdf,video/mp4"
                      style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;"
                    />
                    <small style="color: var(--text-light);">Format: Gambar, PDF, atau Video MP4 (maks. 10MB)</small>
                    <div id="file-upload-progress-${
                     disbursement.id
                    }" style="display: none; margin-top: 5px;">
                      <div style="font-size: 0.85rem; color: var(--primary-color);">Mengupload file...</div>
                    </div>
                  </div>
                  <button type="submit" class="submit-btn" style="width: auto;">Tambah Aktivitas</button>
                </form>
              </div>
              <div id="activities-list-${disbursement.id}">
                ${renderActivities(disbursement.activities || [])}
              </div>
            </div>
          </div>
        `
      )
      .join("");
    } catch (error) {
     console.error("Error loading disbursements:", error);
     listElement.innerHTML =
      '<p class="empty">Gagal memuat data pencairan.</p>';
    }
   }

   // Handle login
   document
    .getElementById("login-form")
    .addEventListener("submit", async (e) => {
     e.preventDefault();
     const password = document.getElementById("password").value;
     const errorDiv = document.getElementById("login-error");

     try {
      const response = await fetch("/api/admin/login", {
       method: "POST",
       headers: {
        "Content-Type": "application/json",
       },
       body: JSON.stringify({ password }),
      });

      if (!response.ok) {
       const error = await response.json();
       throw new Error(error.error || "Login failed");
      }

      const data = await response.json();
      adminToken = data.token;
      localStorage.setItem("admin_token", data.token);
      localStorage.setItem("admin_token_expiry", data.expires_at);

      showDashboard();
     } catch (error) {
      errorDiv.textContent = error.message;
      errorDiv.style.display = "block";
     }
    });

   // Handle disbursement form
   document
    .getElementById("disbursement-form")
    .addEventListener("submit", async (e) => {
     e.preventDefault();

     const submitBtn = e.target.querySelector('button[type="submit"]');
     const originalText = submitBtn.textContent;
     submitBtn.disabled = true;
     submitBtn.textContent = "Memproses...";

     try {
      const formData = new FormData(e.target);
      const data = {
       amount: parseInt(formData.get("amount")),
       description: formData.get("description"),
      };

      const response = await fetch("/api/admin/disbursements", {
       method: "POST",
       headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${adminToken}`,
       },
       body: JSON.stringify(data),
      });

      if (response.status === 401) {
       logout();
       return;
      }

      if (!response.ok) {
       const error = await response.json();
       throw new Error(error.error || "Failed to create disbursement");
      }

      // Reset form
      e.target.reset();
      await loadAdminData();
     } catch (error) {
      alert("Terjadi kesalahan: " + error.message);
     } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
     }
    });

   // Auto-refresh every 30 seconds
   setInterval(() => {
    if (adminToken) {
     loadAdminData();
    }
   }, 30000);
  </script>
 </body>
</html>
