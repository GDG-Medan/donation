<!DOCTYPE html>
<html lang="id">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - GDG Donation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="stylesheet" href="/styles.css" />
  <script>
   // Grafana configuration (should be set via environment or config endpoint)
   // For security, consider using a backend proxy endpoint instead
   window.GRAFANA_CONFIG = {
    endpoint: null, // Will be set from environment if available
    auth: null, // Will be set from environment if available
   };
  </script>
  <style>
   .admin-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
   }
   .login-form {
    max-width: 400px;
    margin: 100px auto;
    background: var(--card-bg);
    padding: 40px;
    border-radius: 8px;
    box-shadow: var(--shadow);
   }
   .admin-dashboard {
    display: none;
   }
   .admin-dashboard.active {
    display: block;
   }
   .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
   }
   .disbursement-form {
    background: var(--card-bg);
    padding: 25px;
    border-radius: 8px;
    box-shadow: var(--shadow);
    margin-bottom: 30px;
   }
   .disbursements-list {
    background: var(--card-bg);
    padding: 25px;
    border-radius: 8px;
    box-shadow: var(--shadow);
   }
   .disbursement-item {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
   }
   .disbursement-item:last-child {
    border-bottom: none;
   }
   .disbursement-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
   }
   .disbursement-actions {
    display: flex;
    gap: 10px;
   }
   .activity-btn {
    padding: 5px 15px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
   }
   .activity-btn:hover {
    opacity: 0.9;
   }
   .activities-section {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
    display: none;
   }
   .activities-section.active {
    display: block;
   }
   .activity-form {
    background: var(--bg-color);
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 15px;
   }
   .activity-item {
    padding: 10px;
    background: var(--bg-color);
    border-radius: 6px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: start;
   }
   .activity-time {
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 5px;
   }
   .activity-description {
    color: var(--text-color);
    flex: 1;
   }
   .logout-btn {
    float: right;
    padding: 10px 20px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 20px;
   }
   .logout-btn:hover {
    background: #c82333;
   }
  </style>
 </head>
 <body>
  <div class="admin-container">
   <!-- Login Form -->
   <div id="login-section" class="login-form">
    <h2>Admin Login</h2>
    <form id="login-form">
     <div class="form-group">
      <label for="password">Password</label>
      <input type="password" id="password" name="password" required />
     </div>
     <button type="submit" class="submit-btn">Login</button>
    </form>
    <div
     id="login-error"
     style="color: #dc3545; margin-top: 10px; display: none"
    ></div>
   </div>

   <!-- Admin Dashboard -->
   <div id="admin-dashboard" class="admin-dashboard">
    <button class="logout-btn" onclick="logout()">Logout</button>
    <h1>Admin Dashboard</h1>

    <!-- Stats -->
    <div class="stats-grid">
     <div class="summary-card">
      <h3>Total Terkumpul</h3>
      <p class="amount" id="admin-total-raised">Rp 0</p>
     </div>
     <div class="summary-card">
      <h3>Total Disalurkan</h3>
      <p class="amount" id="admin-total-disbursed">Rp 0</p>
     </div>
     <div class="summary-card">
      <h3>Jumlah Donatur</h3>
      <p class="amount" id="admin-donor-count">0</p>
     </div>
     <div class="summary-card">
      <h3>Saldo Tersedia</h3>
      <p class="amount" id="admin-balance">Rp 0</p>
     </div>
    </div>

    <!-- Add Disbursement Form -->
    <div class="disbursement-form">
     <h2>Tambah Pencairan</h2>
     <form id="disbursement-form">
      <div class="form-group">
       <label for="disbursement-amount">Jumlah (Rp) *</label>
       <input
        type="number"
        id="disbursement-amount"
        name="amount"
        min="1"
        required
       />
      </div>
      <div class="form-group">
       <label for="disbursement-description">Deskripsi *</label>
       <textarea
        id="disbursement-description"
        name="description"
        rows="3"
        required
       ></textarea>
      </div>
      <button type="submit" class="submit-btn">Tambah Pencairan</button>
     </form>
    </div>

    <!-- Disbursements List -->
    <div class="disbursements-list">
     <h2>Riwayat Pencairan</h2>
     <div id="disbursements-list">
      <p class="loading">Memuat data...</p>
     </div>
    </div>
   </div>
  </div>

  <script>
   // Grafana.net Logging Utility (Client-side)
   const GrafanaLogger = {
    endpoint: null,
    auth: null,
    serviceName: "gdg-donation-admin",
    enabled: false,

    async init() {
     // Get credentials from secure API endpoint (admin only)
     try {
      const response = await fetch("/api/admin/grafana-config", {
       headers: {
        Authorization: `Bearer ${adminToken || ""}`,
       },
      });

      if (response.ok) {
       const config = await response.json();
       if (config.enabled) {
        this.endpoint = config.endpoint;
        this.auth = config.auth;
        this.enabled = true;
       }
      }
     } catch (error) {
      // Silently fail - logging is optional
      console.debug("Grafana config not available:", error);
     }
    },

    getSeverityNumber(level) {
     const severityMap = {
      debug: 5,
      info: 9,
      warn: 13,
      error: 17,
      fatal: 21,
     };
     return severityMap[level.toLowerCase()] || 9;
    },

    async sendLog(level, message, context = {}, error = null) {
     if (!this.enabled) {
      // Fallback to console if Grafana is not configured
      const consoleMethod = level === "error" ? "error" : level === "warn" ? "warn" : "log";
      console[consoleMethod](`[${level.toUpperCase()}] ${message}`, context, error);
      return;
     }

     try {
      const timestamp = Date.now() * 1000000; // Convert to nanoseconds

      const logRecord = {
       timeUnixNano: timestamp.toString(),
       severityNumber: this.getSeverityNumber(level),
       severityText: level.toUpperCase(),
       body: {
        stringValue: message,
       },
       attributes: [
        {
         key: "log.level",
         value: { stringValue: level },
        },
        {
         key: "service.name",
         value: { stringValue: this.serviceName },
        },
        {
         key: "environment",
         value: { stringValue: "production" },
        },
        {
         key: "source",
         value: { stringValue: "admin-frontend" },
        },
       ],
      };

      // Add error details if present
      if (error) {
       logRecord.attributes.push(
        {
         key: "error.type",
         value: { stringValue: error.name || "Error" },
        },
        {
         key: "error.message",
         value: { stringValue: error.message || "" },
        },
        {
         key: "error.stack",
         value: { stringValue: error.stack || "" },
        }
       );
      }

      // Add custom context attributes
      Object.entries(context).forEach(([key, value]) => {
       logRecord.attributes.push({
        key: `context.${key}`,
        value: {
         stringValue: typeof value === "object" ? JSON.stringify(value) : String(value),
        },
       });
      });

      const payload = {
       resourceLogs: [
        {
         resource: {
          attributes: [
           {
            key: "service.name",
            value: { stringValue: this.serviceName },
           },
           {
            key: "service.version",
            value: { stringValue: "1.0.0" },
           },
          ],
         },
         scopeLogs: [
          {
           logRecords: [logRecord],
          },
         ],
        },
       ],
      };

      // Send to Grafana.net (fire and forget)
      fetch(this.endpoint, {
       method: "POST",
       headers: {
        "Content-Type": "application/json",
        Authorization: `Basic ${this.auth}`,
       },
       body: JSON.stringify(payload),
      }).catch((err) => {
       // Silently fail - we don't want logging failures to break the app
       console.error("Failed to send log to Grafana:", err);
      });
     } catch (err) {
      // Silently fail
      console.error("Error in Grafana logger:", err);
     }
    },

    async debug(message, context) {
     await this.sendLog("debug", message, context);
    },

    async info(message, context) {
     await this.sendLog("info", message, context);
    },

    async warn(message, context) {
     await this.sendLog("warn", message, context);
    },

    async error(message, error, context) {
     await this.sendLog("error", message, context, error);
    },

    async fatal(message, error, context) {
     await this.sendLog("fatal", message, context, error);
    },
   };

   // Initialize logger (will be called after token is available)
   async function initGrafanaLogger() {
    if (adminToken) {
     await GrafanaLogger.init();
    }
   }

   let adminToken = localStorage.getItem("admin_token");
   let tokenExpiry = localStorage.getItem("admin_token_expiry");

   // Initialize on page load (async IIFE)
   (async () => {
    // Check if token is valid
    if (adminToken && tokenExpiry && new Date(tokenExpiry) > new Date()) {
     await initGrafanaLogger();
     showDashboard();
    } else {
     showLogin();
     localStorage.removeItem("admin_token");
     localStorage.removeItem("admin_token_expiry");
    }
   })();

   function showLogin() {
    document.getElementById("login-section").style.display = "block";
    document.getElementById("admin-dashboard").classList.remove("active");
   }

   function showDashboard() {
    document.getElementById("login-section").style.display = "none";
    document.getElementById("admin-dashboard").classList.add("active");
    loadAdminData();
   }

   async function logout() {
    await GrafanaLogger.info("Admin logout");
    localStorage.removeItem("admin_token");
    localStorage.removeItem("admin_token_expiry");
    adminToken = null;
    showLogin();
   }

   // Format currency
   function formatCurrency(amount) {
    return new Intl.NumberFormat("id-ID", {
     style: "currency",
     currency: "IDR",
     minimumFractionDigits: 0,
    }).format(amount);
   }

   // Format date in WIB (UTC+7)
   function formatDate(dateString) {
    // SQLite DATETIME format: "2025-12-01 19:11:26" (stored as UTC)
    // Convert to ISO format and treat as UTC
    let date;

    // Handle SQLite datetime format (YYYY-MM-DD HH:MM:SS)
    if (dateString.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/)) {
     // Replace space with T and add Z to indicate UTC
     date = new Date(dateString.replace(" ", "T") + "Z");
    } else if (
     dateString.includes("T") &&
     !dateString.includes("Z") &&
     !dateString.includes("+")
    ) {
     // ISO format without timezone, treat as UTC
     date = new Date(dateString + "Z");
    } else {
     date = new Date(dateString);
    }

    // Convert to WIB (UTC+7) - Asia/Jakarta
    return new Intl.DateTimeFormat("id-ID", {
     year: "numeric",
     month: "long",
     day: "numeric",
     hour: "2-digit",
     minute: "2-digit",
     timeZone: "Asia/Jakarta",
     timeZoneName: "short",
    }).format(date);
   }

   // Format datetime for input (YYYY-MM-DDTHH:mm)
   function formatDateTimeForInput(dateString) {
    let date;
    if (dateString.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/)) {
     date = new Date(dateString.replace(" ", "T") + "Z");
    } else if (
     dateString.includes("T") &&
     !dateString.includes("Z") &&
     !dateString.includes("+")
    ) {
     date = new Date(dateString + "Z");
    } else {
     date = new Date(dateString);
    }

    // Convert to WIB (UTC+7) and format for datetime-local input
    const wibDate = new Date(date.getTime() + 7 * 60 * 60 * 1000);
    const year = wibDate.getUTCFullYear();
    const month = String(wibDate.getUTCMonth() + 1).padStart(2, "0");
    const day = String(wibDate.getUTCDate()).padStart(2, "0");
    const hours = String(wibDate.getUTCHours()).padStart(2, "0");
    const minutes = String(wibDate.getUTCMinutes()).padStart(2, "0");

    return `${year}-${month}-${day}T${hours}:${minutes}`;
   }

   // Render activities list
   function renderActivities(activities) {
    if (activities.length === 0) {
     return '<p style="color: var(--text-light); font-style: italic;">Belum ada aktivitas.</p>';
    }

    return activities
     .map(
      (activity) => {
       const files = activity.files || [];
       const hasFiles = files.length > 0;
       
       return `
        <div class="activity-item">
          <div style="flex: 1;">
            <div class="activity-time">${formatDate(
             activity.activity_time
            )}</div>
            <div class="activity-description">${activity.description}</div>
            ${
             hasFiles
              ? `
              <div style="margin-top: 10px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-color); font-size: 0.9rem;">File (${files.length}):</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                  ${files.map((file) => {
                   const isImage = file.file_url.match(/\.(jpg|jpeg|png|gif|webp)$/i);
                   const isVideo = file.file_url.match(/\.(mp4|mov)$/i);
                   
                   return `
                    <div style="border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden;">
                      ${isImage 
                        ? `<img src="${file.file_url}" alt="${file.file_name || "Image"}" style="width: 100%; height: 150px; object-fit: cover; display: block;" />`
                        : isVideo
                        ? `<video src="${file.file_url}" style="width: 100%; height: 150px; object-fit: cover; display: block;" muted></video>`
                        : `<div style="width: 100%; height: 150px; display: flex; align-items: center; justify-content: center; background: var(--bg-color);">
                             <span style="font-size: 2rem;">ðŸ“„</span>
                           </div>`
                      }
                      <div style="padding: 8px; font-size: 0.8rem; color: var(--text-light); text-overflow: ellipsis; overflow: hidden; white-space: nowrap;" title="${file.file_name || "File"}">
                        ${file.file_name || "File"}
                      </div>
                    </div>
                   `;
                  }).join("")}
                </div>
              </div>
            `
              : ""
            }
          </div>
        </div>
      `;
      }
     )
     .join("");
   }

   // Toggle activities section
   function toggleActivities(disbursementId) {
    const section = document.getElementById(`activities-${disbursementId}`);
    section.classList.toggle("active");
   }

   // Add activity
   async function addActivity(event, disbursementId) {
    event.preventDefault();

    const timeInput = document.getElementById(
     `activity-time-${disbursementId}`
    );
    const descriptionInput = document.getElementById(
     `activity-description-${disbursementId}`
    );
    const fileInput = document.getElementById(
     `activity-file-${disbursementId}`
    );
    const progressDiv = document.getElementById(
     `file-upload-progress-${disbursementId}`
    );

    // Convert local datetime to UTC for storage
    const localDateTime = timeInput.value; // Format: YYYY-MM-DDTHH:mm
    const localDate = new Date(localDateTime);
    // Convert from WIB (UTC+7) to UTC
    const utcDate = new Date(localDate.getTime() - 7 * 60 * 60 * 1000);
    const activityTime = utcDate.toISOString().slice(0, 19).replace("T", " ");

    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = "Memproses...";

    const uploadedFiles = [];

    try {
     // Upload files if provided
     if (fileInput.files && fileInput.files.length > 0) {
      progressDiv.style.display = "block";
      progressDiv.innerHTML = `<div style="font-size: 0.85rem; color: var(--primary-color);">Mengupload ${fileInput.files.length} file...</div>`;

      // Upload all files
      for (let i = 0; i < fileInput.files.length; i++) {
       const file = fileInput.files[i];
       progressDiv.innerHTML = `<div style="font-size: 0.85rem; color: var(--primary-color);">Mengupload file ${i + 1} dari ${fileInput.files.length}...</div>`;

       const formData = new FormData();
       formData.append("file", file);

       const uploadResponse = await fetch("/api/admin/upload", {
        method: "POST",
        headers: {
         Authorization: `Bearer ${adminToken}`,
        },
        body: formData,
       });

       if (uploadResponse.status === 401) {
        logout();
        return;
       }

       if (!uploadResponse.ok) {
        const error = await uploadResponse.json();
        throw new Error(error.error || `File upload failed: ${file.name}`);
       }

       const uploadData = await uploadResponse.json();
       uploadedFiles.push({
        file_url: uploadData.file_url,
        file_name: uploadData.file_name,
        file_type: uploadData.file_type,
       });
      }
      progressDiv.style.display = "none";
     }

     // Create activity with files
     const response = await fetch(
      `/api/admin/disbursements/${disbursementId}/activities`,
      {
       method: "POST",
       headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${adminToken}`,
       },
       body: JSON.stringify({
        activity_time: activityTime,
        description: descriptionInput.value,
        files: uploadedFiles,
       }),
      }
     );

     if (response.status === 401) {
      logout();
      return;
     }

     if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || "Failed to create activity");
     }

     // Reset form
     timeInput.value = "";
     descriptionInput.value = "";
     fileInput.value = "";
     progressDiv.style.display = "none";
     const selectedFilesDiv = document.getElementById(`selected-files-${disbursementId}`);
     if (selectedFilesDiv) selectedFilesDiv.innerHTML = "";

     // Reload disbursements to show new activity
     await loadDisbursements();
     } catch (error) {
      await GrafanaLogger.error("Failed to add activity", error, {
       disbursementId,
       hasFiles: fileInput.files?.length > 0,
      });
      alert("Terjadi kesalahan: " + error.message);
      progressDiv.style.display = "none";
     } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
     }
    }

   // Load admin data
   async function loadAdminData() {
    await loadStats();
    await loadDisbursements();
   }

   // Load stats
   async function loadStats() {
    try {
     const response = await fetch("/api/stats");
     if (!response.ok) throw new Error("Failed to load stats");

     const data = await response.json();
     await GrafanaLogger.info("Stats loaded", {
      totalRaised: data.total_raised,
      totalDisbursed: data.total_disbursed,
      donorCount: data.donor_count,
     });
     const balance = data.total_raised - data.total_disbursed;

     document.getElementById("admin-total-raised").textContent = formatCurrency(
      data.total_raised || 0
     );
     document.getElementById("admin-total-disbursed").textContent =
      formatCurrency(data.total_disbursed || 0);
     document.getElementById("admin-donor-count").textContent =
      data.donor_count || 0;
     document.getElementById("admin-balance").textContent = formatCurrency(
      balance || 0
     );
    } catch (error) {
     await GrafanaLogger.error("Failed to load stats", error);
     console.error("Error loading stats:", error);
    }
   }

   // Load disbursements
   async function loadDisbursements() {
    const listElement = document.getElementById("disbursements-list");

    try {
     const response = await fetch("/api/admin/disbursements", {
      headers: {
       Authorization: `Bearer ${adminToken}`,
      },
     });

     if (response.status === 401) {
      logout();
      return;
     }

     if (!response.ok) throw new Error("Failed to load disbursements");

     const disbursements = await response.json();

     // Ensure disbursements is an array
     if (!Array.isArray(disbursements)) {
      await GrafanaLogger.error("Invalid disbursements response format", null, {
       responseType: typeof disbursements,
       response: JSON.stringify(disbursements).substring(0, 200),
      });
      console.error("Invalid response format:", disbursements);
      listElement.innerHTML =
       '<p class="empty">Format data tidak valid. Silakan refresh halaman.</p>';
      return;
     }

     await GrafanaLogger.info("Disbursements loaded", {
      count: disbursements.length,
     });

     if (disbursements.length === 0) {
      listElement.innerHTML = '<p class="empty">Belum ada pencairan.</p>';
      return;
     }

     listElement.innerHTML = disbursements
      .map(
       (disbursement) => `
          <div class="disbursement-item">
            <div class="disbursement-header">
              <div>
                <div style="font-weight: 600; margin-bottom: 5px;">${
                 disbursement.description
                }</div>
                <div style="font-size: 0.85rem; color: var(--text-light);">${formatDate(
                 disbursement.created_at
                )}</div>
              </div>
              <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);">
                  ${formatCurrency(disbursement.amount)}
                </div>
                <button class="activity-btn" onclick="toggleActivities(${
                 disbursement.id
                })">
                  ${
                   (disbursement.activities || []).length > 0
                    ? "Lihat Aktivitas"
                    : "Tambah Aktivitas"
                  }
                </button>
              </div>
            </div>
            <div class="activities-section" id="activities-${disbursement.id}">
              <div class="activity-form">
                <h4 style="margin-bottom: 10px;">Tambah Aktivitas</h4>
                <form onsubmit="addActivity(event, ${disbursement.id})">
                  <div class="form-group">
                    <label>Waktu Aktivitas (WIB) *</label>
                    <input 
                      type="datetime-local" 
                      id="activity-time-${disbursement.id}" 
                      required
                      style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;"
                    />
                  </div>
                  <div class="form-group">
                    <label>Deskripsi Aktivitas *</label>
                    <textarea 
                      id="activity-description-${disbursement.id}" 
                      rows="3" 
                      required
                      placeholder="Contoh: Tiba di lokasi untuk mendistribusikan paket sembako"
                      style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;"
                    ></textarea>
                  </div>
                  <div class="form-group">
                    <label>Upload File (Opsional - Bisa Multiple)</label>
                    <input 
                      type="file" 
                      id="activity-file-${disbursement.id}" 
                      accept="image/*,application/pdf,video/mp4,video/quicktime"
                      multiple
                      style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;"
                    />
                    <small style="color: var(--text-light);">Format: Gambar, PDF, atau Video MP4/MOV (maks. 10MB per file)</small>
                    <div id="file-upload-progress-${
                     disbursement.id
                    }" style="display: none; margin-top: 5px;">
                      <div style="font-size: 0.85rem; color: var(--primary-color);">Mengupload file...</div>
                    </div>
                    <div id="selected-files-${disbursement.id}" style="margin-top: 10px;"></div>
                  </div>
                  <button type="submit" class="submit-btn" style="width: auto;">Tambah Aktivitas</button>
                </form>
              </div>
              <div id="activities-list-${disbursement.id}">
                ${renderActivities(disbursement.activities || [])}
              </div>
            </div>
          </div>
        `
      )
      .join("");
    } catch (error) {
     await GrafanaLogger.error("Failed to load disbursements", error);
     console.error("Error loading disbursements:", error);
     listElement.innerHTML =
      '<p class="empty">Gagal memuat data pencairan.</p>';
    }
   }

   // Handle login
   document
    .getElementById("login-form")
    .addEventListener("submit", async (e) => {
     e.preventDefault();
     const password = document.getElementById("password").value;
     const errorDiv = document.getElementById("login-error");

     try {
      const response = await fetch("/api/admin/login", {
       method: "POST",
       headers: {
        "Content-Type": "application/json",
       },
       body: JSON.stringify({ password }),
      });

      if (!response.ok) {
       const error = await response.json();
       throw new Error(error.error || "Login failed");
      }

      const data = await response.json();
      adminToken = data.token;
      localStorage.setItem("admin_token", data.token);
      localStorage.setItem("admin_token_expiry", data.expires_at);

      await initGrafanaLogger();
      await GrafanaLogger.info("Admin login successful");
      showDashboard();
     } catch (error) {
      await GrafanaLogger.warn("Admin login failed", {
       reason: error.message || "Login failed",
      });
      errorDiv.textContent = error.message;
      errorDiv.style.display = "block";
     }
    });

   // Handle disbursement form
   document
    .getElementById("disbursement-form")
    .addEventListener("submit", async (e) => {
     e.preventDefault();

     const submitBtn = e.target.querySelector('button[type="submit"]');
     const originalText = submitBtn.textContent;
     submitBtn.disabled = true;
     submitBtn.textContent = "Memproses...";

     try {
      const formData = new FormData(e.target);
      const data = {
       amount: parseInt(formData.get("amount")),
       description: formData.get("description"),
      };

      const response = await fetch("/api/admin/disbursements", {
       method: "POST",
       headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${adminToken}`,
       },
       body: JSON.stringify(data),
      });

      if (response.status === 401) {
       logout();
       return;
      }

      if (!response.ok) {
       const error = await response.json();
       throw new Error(error.error || "Failed to create disbursement");
      }

      await GrafanaLogger.info("Disbursement created", {
       amount: data.amount,
       descriptionLength: data.description?.length || 0,
      });

      // Reset form
      e.target.reset();
      await loadAdminData();
     } catch (error) {
      await GrafanaLogger.error("Failed to create disbursement", error, {
       amount: amountInput.value,
       hasDescription: !!descriptionInput.value,
      });
      alert("Terjadi kesalahan: " + error.message);
     } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
     }
    });

   // Auto-refresh every 30 seconds
   setInterval(() => {
    if (adminToken) {
     loadAdminData();
    }
   }, 30000);
  </script>
 </body>
</html>
